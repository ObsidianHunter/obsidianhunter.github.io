---
layout: post
title: "Detección y Erradicación de un malware FileLess [Living off the Land]"
date: 2026-01-03
categories: [blue-team]
permalink: /deteccion-fileless/
---

# DETECCIÓN Y ERRADICACIÓN DE UN MALWARE FILELESS 

- <span class="solo-color-neon">Laboratorio creado en un entorno controlado, con mis propias máquinas virtuales y en un entorno totalmente aislado. </span>
- <span class="solo-color-neon">El archivo sólo demuestra características de un malware Fileless, sin embargo, no tiene ningún tipo de carga ni payload malicioso. </span>
- <span class="solo-color-neon">No se comparte ni payloads, ni malware ni nada que pueda usarse de manera no ética, ni en este laboratorio ni en ninguno que haga en el futuro.</span>
- <span class="solo-color-neon">Material de blue team que busca instruir sobre la detección y eliminación de este tipo de malware.</span>
- <span class="solo-color-neon">No me responsabilizo del mal uso de este laboratorio. Queda prohibido usar parte o la totalidad del tutorial para usarlo en ordenadores de terceros.</span>
- <span class="solo-color-neon">Gracias por respetar estas condiciones.</span>

Hoy voy a hacer un laboratorio un tanto especial. Normalmente todo el malware que se expande hoy en día es un archivo. Ya sabes, ejecutas un archivo, crea persistencia, exfiltra datos, descarga otras cosas, roba información... Lo típico, hay un archivo, ya se ejecutando sus propias órdenes o recibiéndolas. Pero si te digo que hay ataques donde no interviene un archivo, ¿cómo te quedas?. Aquí entra el concepto de <span class="solo-color-neon">FileLess malware</span>, no hace falta que haya un archivo involucrado (de hecho, podría ser borrado simplemente para mejorar su evasión) porque está cargado en la <span class="solo-color-neon">memoria RAM</span>. Hoy voy a hacer justo esto, con una creación muy simple de un FileLess <span class="solo-color-neon">(sin características malignas)</span>.

Para crear este fileless, he usado <span class="solo-color-neon">memfd_create</span> (ojo, esto sólo funciona en Linux, Windows es otro tema, que pondré en otro lab), lo que me permite reservar en <span class="solo-color-neon">la memoria RAM</span> espacio para ejecutar código (no tiene una referencia en el disco duro). Para crear el control de comando, voy a usar mi máquina virtual en la que corre Kali Linux. Como se ve en mi escritorio, no existe ningún archivo:

![Imagen4](https://github.com/user-attachments/assets/b1290f7c-49fb-40f1-a72c-560fceea05a0)

Mi Fileless tiene la dirección privada de Kali para comunicarse con él y establecer la conexión. Como ves, con un <span class="solo-color-neon">nc</span> y escuchando en el puerto que puse ya tengo el control:

![Imagen2](https://github.com/user-attachments/assets/e3a4f2e7-589f-472d-bee0-248849cefee3)

Ahora vamos a detectarlo. Aunque parezca un ataque muy sofisticado, si tienes algunas nociones de Linux (no te hace falta herramientas avanzadas, aunque te ayudan mucho) no es muy difícil de detectar, de hecho, voy a usar sólo herramientas <span class="solo-color-neon">living off the lands</span>. Primero quiero saber qué conexiones salientes hay y qué PID tienen, para eso usaré el comando ss -antp:

![Imagen3](https://github.com/user-attachments/assets/4ee7ed5a-22fc-4068-9a21-504f6bcfed3f)

Veo una cosa muy rar, primero que si ves un <span class="solo-color-neon">puerto 4444</span> hay que levantar una bandera roja de inmediato <span class="solo-color-neon">(es un puerto asociado a malware y algunos archivos creados con Metasploit)</span>. En este caso yo tenía todas las conexiones de red posibles quitadas (nada que yo haya iniciado estaba conectado a internet). Por lo tanto, la única IP que veo sospechosa es la de <span class="solo-color-neon">192.168.0.200</span> (es la de mi Kali). Por lo tanto, voy a coger su PID <span class="solo-color-neon">(1768)</span> y a seguir investigando.

Si pongo <span class="solo-color-neon">ps u -p 1768</span> me muestra información valiosa de ese proceso. Veo cosas muy interesantes ahí, por ejemplo, en el <span class="solo-color-neon">STAT</span> tiene el valor de <span class="solo-color-neon">S</span> (el proceso está esperando mis instrucciones) y en <span class="solo-color-neon">Command</span> está <span class="solo-color-neon">/bin/bash -i</span> (es un Shell inversa, en este caso, es lo que me permite la conexión con la máquina Kali. En este caso, usa la <span class="solo-color-neon">técnica T1059.004</span> de la <span class="solo-color-neon">Táctica Execution</span>, que es la de <span class="solo-color-neon">Unix Shell</span>). Si hay una Shell inversa, con un proceso esperando instrucciones y un puerto malicioso, la duda ofende, es un <span class="solo-color-neon">command and control</span> de manual (con la <span class="solo-color-neon">técnica T1071.001</span>, que es <span class="solo-color-neon">Application Layer Protocol</span>):

![Imagen5](https://github.com/user-attachments/assets/db159065-c082-4b85-9465-d78b091374ab)

Como no hay un archivo asociado, voy a ver los descriptores de archivo abiertos por el proceso mirando en la carpeta <span class="solo-color-neon">proc</span>. Con esto veré todos los recursos que está usando el bicho:

![Imagen7](https://github.com/user-attachments/assets/b9bfef78-a6f9-49ee-91a4-568c8cd090f8)

Como se ve en la imagen, veo lo sockets <span class="solo-color-neon">(las comunicaciones entre el centro de comando y mi ordenador)</span> y veo algo muy, muy interesante. Está el <span class="solo-color-neon">memfd</span> (En este caso dentro de la táctica <span class="solo-color-neon">Defense Evasion</span>, usa la <span class="solo-color-neon">técnica T1620</span> que es <span class="solo-color-neon">Reflective Code Loading</span>), lo que indica un archivo que sólo está habitando en mi preciosa RAM, no hay ningún archivo asociado (lo que indica el deleted. En este caso usa la misma táctica, pero con la <span class="solo-color-neon">técnica T1070.004</span> que es <span class="solo-color-neon">File Deletion</span>).

Estamos ante un caso de FileLess, hay una comunicación con mi Kali sin usar un archivo, todo el código está cargado en la RAM. En este caso, se ha puesto al lado una frase para que parezca algo legítimo (<span class="solo-color-neon">ArchivoActualizacion</span>, misma táctia anterior pero en esta usa la <span class="solo-color-neon">técnia T1036.005</span> que es <span class="solo-color-neon">Match Legitimate Name</span>). Voy a coger el número <span class="solo-color-neon">3</span> que es el que relaciona la función que quiero tener, porque voy a realizar una copia de la evidencia. En este caso, usaré <span class="solo-color-neon">cp /proc/1768/fd/3 postmortem.sh </span>. Si hago un cat simple, me sale lo siguiente:

![Imagen8](https://github.com/user-attachments/assets/9e1e3ae8-ed00-43c4-a277-1a0d87ddd3e3)

<span class="solo-color-neon">La Shell inversa, junto a la ip que apunta y el puerto de la máquina remota que lo está recibiendo. </span>

Con un simple <span class="solo-color-neon">kill 9 1768</span>, acabo con el proceso en memoria. Ahora voy a volver a buscarlo, a ver si está. Si hago un <span class="solo-color-neon">ls /proc/1768</span> ya no habrá nada porque no lo ha encontrado, ya lo hemos eliminado de la memoria.

Si vuelvo a ver las conexiones de red, efectivamente, hemos contenido la amenaza, porque ya no aparece:

![Imagen10](https://github.com/user-attachments/assets/ce90c841-cc94-4ec3-b09a-eb704fcee96b)

Si vuelvo a Kali, se ha <span class="solo-color-neon">salido de la Shell</span>, ya no estoy dentro del otro ordenador. Ahora sólo faltaría <span class="solo-color-neon">bloquear la ip del atacante y bloquear el puerto 4444</span> (esto es por si acaso, obviamente los malwares reales no van a ser tan evidentes pero oye, nunca se sabe y hombre precavido vale por dos):

![Imagen11](https://github.com/user-attachments/assets/87cd25e9-55d8-427c-8adf-d0c325d4d89b)

En este caso, el malware ha usado las <span class="solo-color-neon">tácticas de Execution, Defense Evasión y Command and control</span>. No ha construido ninguna persistencia (es raro, pero puede pasar que sea un malware de un único disparo).

<span class="solo-color-neon">Laboratorio creado: 03/01/2026</span>

<span class="solo-color-neon">Laboratorio publicado: 04/01/2026</span>
